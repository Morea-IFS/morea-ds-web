{% extends 'layout.html' %}
{% load static %}

{% block title %}Dashboard de Dispositivos{% endblock %}

{% block stylesCustom %}
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #3498db;
            --water-color: #1114e6ff;
            --energy-color: #f39c12;
            --light-bg: #f8f9fa;
            --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .dashboard-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 1.5rem;
            border-radius: 10px;
            margin-bottom: 2rem;
            box-shadow: var(--card-shadow);
        }
        
        .device-selector-container {
            background-color: white;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: var(--card-shadow);
        }
        
        .chart-section {
            display: none;
            margin-bottom: 2rem;
        }
        
        .chart-container {
            position: relative;
            width: 100%;
            height: 60vh;
            margin-bottom: 2rem;
            background-color: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: var(--card-shadow);
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #eee;
        }
        
        .chart-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--secondary-color);
        }
        
        .loader {
            border: 8px solid #f3f3f3;
            border-radius: 50%;
            border-top: 8px solid var(--primary-color);
            width: 60px;
            height: 60px;
            animation: spin 1.5s linear infinite;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: none;
        }
        
        .stats-container {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }
        
        .stat-card {
            flex: 1;
            min-width: 200px;
            background-color: white;
            border-radius: 8px;
            padding: 1rem;
            box-shadow: var(--card-shadow);
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        
        .water-stat {
            color: var(--water-color);
        }
        
        .energy-stat {
            color: var(--energy-color);
        }
        
        .stat-label {
            color: #6c757d;
            font-size: 0.9rem;
        }
        
        .no-data-container {
            text-align: center;
            padding: 3rem;
            background-color: white;
            border-radius: 10px;
            box-shadow: var(--card-shadow);
        }
        
        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }
        
        /* Responsividade */
        @media (max-width: 768px) {
            .chart-container {
                height: 50vh;
                padding: 1rem;
            }
            
            .stats-container {
                flex-direction: column;
            }
            
            .stat-card {
                min-width: 100%;
            }
        }
    </style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="dashboard-header">
        <h1 class="mb-2">Dashboard de Dispositivos</h1>
        <p class="mb-0">Visualize e analise dados dos seus dispositivos</p>
    </div>

    <div class="device-selector-container">
        <div class="form-group">
            <label for="deviceSelector" class="form-label fw-bold">Selecione um Dispositivo:</label>
            <select class="form-select" id="deviceSelector">
                <option value="" data-type="">-- Selecione um dispositivo --</option>
                {% for device in devices %}
                    <option value="{{ device.id }}" data-type="{{ device.type }}">{{ device.name }}</option>
                {% endfor %}
            </select>
        </div>
    </div>

    <div id="water-charts" class="chart-section">
        <h3 id="water-device-name" class="mb-3"></h3>
        
        <div class="stats-container" id="water-stats">
            <div class="stat-card">
                <div class="stat-value water-stat" id="water-current-volume">--</div>
                <div class="stat-label">Volume Atual (L)</div>
            </div>
            <div class="stat-card">
                <div class="stat-value water-stat" id="water-max-volume">--</div>
                <div class="stat-label">Consumo Máximo (L)</div>
            </div>
            <div class="stat-card">
                <div class="stat-value water-stat" id="water-total-volume">--</div>
                <div class="stat-label">Consumo Total (L)</div>
            </div>
        </div>
        
        <div class="chart-container">
            <div class="chart-header">
                <div class="chart-title">Consumo de Água</div>
            </div>
            <div class="loader" id="volume-loader"></div>
            <canvas id="volumeChart"></canvas>
        </div>
    </div>

    <div id="energy-charts" class="chart-section">
        <h3 id="energy-device-name" class="mb-3"></h3>
        
        <div class="stats-container" id="energy-stats">
            <div class="stat-card">
                <div class="stat-value energy-stat" id="energy-current-kwh">--</div>
                <div class="stat-label">Consumo Atual (kWh)</div>
            </div>
            <div class="stat-card">
                <div class="stat-value energy-stat" id="energy-max-kwh">--</div>
                <div class="stat-label">Consumo Máximo (kWh)</div>
            </div>
            <div class="stat-card">
                <div class="stat-value energy-stat" id="energy-total-kwh">--</div>
                <div class="stat-label">Consumo Total (kWh)</div>
            </div>
            <div class="stat-card">
                <div class="stat-value energy-stat" id="energy-max-ampere">--</div>
                <div class="stat-label">Corrente Máxima (A)</div>
            </div>
        </div>
        
        <div class="chart-container">
            <div class="chart-header">
                <div class="chart-title">Consumo de Energia (kWh)</div>
            </div>
            <div class="loader" id="kwh-loader"></div>
            <canvas id="kwhChart"></canvas>
        </div>
        
        <div class="chart-container">
            <div class="chart-header">
                <div class="chart-title">Corrente Elétrica (A)</div>
            </div>
            <div class="loader" id="ampere-loader"></div>
            <canvas id="ampereChart"></canvas>
        </div>
    </div>

    <div id="no-data-message" class="no-data-container" style="display: none;">
        <h4>Não há dados para exibir</h4>
        <p>Não encontramos dados para o dispositivo/tipo selecionado.</p>
    </div>
</div>
{% endblock %}

{% block scriptsCustom %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    console.log("0. Script do dashboard carregado.");

    let chartInstances = {};
    const deviceSelector = document.getElementById('deviceSelector');
    const noDataMessage = document.getElementById('no-data-message');
    
    const dataTypes = { volume: 1, kwh: 2, ampere: 4 };
    const deviceTypes = { water: 1, energy: 2, gas: 3 };

    deviceSelector.addEventListener('change', (event) => {
        console.log("1. Evento 'change' disparado! O usuário selecionou um dispositivo.");

        const selectedOption = event.target.options[event.target.selectedIndex];
        const deviceId = selectedOption.value;
        const deviceType = parseInt(selectedOption.getAttribute('data-type'));
        const deviceName = selectedOption.text;

        console.log("2. Informações do dispositivo selecionado:", { deviceId, deviceType, deviceName });

        document.getElementById('water-charts').style.display = 'none';
        document.getElementById('energy-charts').style.display = 'none';
        noDataMessage.style.display = 'none';

        if (!deviceId) {
            console.log("Nenhum deviceId, encerrando a função.");
            return;
        }

        if (deviceType === deviceTypes.water) {
            console.log("3. Dispositivo de ÁGUA detectado. Preparando para renderizar o gráfico.");
            document.getElementById('water-charts').style.display = 'block';
            document.getElementById('water-device-name').innerText = deviceName;
            renderChart(deviceId, dataTypes.volume, 'volumeChart', 'Volume (L)', 'rgba(54, 162, 235, 1)');
            loadWaterStats(deviceId);
        
        } else if (deviceType === deviceTypes.energy) {
            console.log("3. Dispositivo de ENERGIA detectado. Preparando para renderizar os gráficos.");
            document.getElementById('energy-charts').style.display = 'block';
            document.getElementById('energy-device-name').innerText = deviceName;
            renderChart(deviceId, dataTypes.kwh, 'kwhChart', 'Consumo (kWh)', 'rgba(255, 206, 86, 1)');
            renderChart(deviceId, dataTypes.ampere, 'ampereChart', 'Corrente (A)', 'rgba(255, 99, 132, 1)');
            loadEnergyStats(deviceId);
        } else {
            console.error("ERRO: Tipo de dispositivo desconhecido ou inválido:", deviceType);
        }
    });

    async function renderChart(deviceId, dataType, canvasId, chartLabel, borderColor) {
        console.log(`4. Dentro de renderChart para o canvas '${canvasId}'.`, { deviceId, dataType });

        const loader = document.getElementById(`${canvasId.replace('Chart', '-loader')}`);
        const canvas = document.getElementById(canvasId);
        const ctx = canvas.getContext('2d');
        noDataMessage.style.display = 'none';

        if(loader) loader.style.display = 'block';

        if (chartInstances[canvasId]) {
            chartInstances[canvasId].destroy();
        }

        try {
            const apiUrl = `/api/get-device-data/${deviceId}/${dataType}/`;
            console.log("5. URL da API construída:", apiUrl);
            console.log("6. PRESTES A EXECUTAR O FETCH...");

            const response = await fetch(apiUrl);
            
            console.log("7. Fetch executado! Resposta recebida:", response);

            if (!response.ok) {
                console.error("Erro na resposta da rede:", response.statusText);
                throw new Error(`Erro na rede: ${response.statusText}`);
            }
            
            const data = await response.json();
            console.log("8. Dados recebidos e convertidos para JSON:", data);

            if (!data.values || data.values.length === 0) {
                console.warn("AVISO: Os dados recebidos estão vazios. Exibindo mensagem 'Sem dados'.");
                noDataMessage.style.display = 'block';
                if(loader) loader.style.display = 'none';
                return;
            }

            console.log("9. Dados válidos encontrados. Criando o gráfico...");
            chartInstances[canvasId] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: chartLabel,
                        data: data.values,
                        borderColor: borderColor || 'rgba(75, 192, 192, 1)',
                        backgroundColor: (borderColor || 'rgba(75, 192, 192, 1)').replace('1)', '0.2)'),
                        borderWidth: 2,
                        fill: true,
                        tension: 0.2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { 
                        y: { 
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                        }
                    },
                    animation: { duration: 800, easing: 'easeInOutQuart' }
                }
            });
        } catch (error) {
            console.error(`10. FALHA CRÍTICA ao carregar o gráfico ${chartLabel}:`, error);
            noDataMessage.innerText = `Erro ao carregar os dados: ${error.message}`;
            noDataMessage.style.display = 'block';
        } finally {
            if(loader) loader.style.display = 'none';
        }
    }
    
    async function loadWaterStats(deviceId) {
        try {
            const response = await fetch(`/api/get-device-data/${deviceId}/${dataTypes.volume}/`);
            if (response.ok) {
                const data = await response.json();
                if (data.values && data.values.length > 0) {
                    const values = data.values;
                    const currentVolume = values[values.length - 1];
                    const maxVolume = Math.max(...values);
                    const totalVolume = values.reduce((sum, value) => sum + value, 0);
                    
                    document.getElementById('water-current-volume').textContent = currentVolume.toFixed(2);
                    document.getElementById('water-max-volume').textContent = maxVolume.toFixed(2);
                    document.getElementById('water-total-volume').textContent = totalVolume.toFixed(2);
                }
            }
        } catch (error) {
            console.error('Erro ao carregar estatísticas de água:', error);
        }
    }
    
    async function loadEnergyStats(deviceId) {
        try {
            const [kwhResponse, ampereResponse] = await Promise.all([
                fetch(`/api/get-device-data/${deviceId}/${dataTypes.kwh}/`),
                fetch(`/api/get-device-data/${deviceId}/${dataTypes.ampere}/`)
            ]);
            
            if (kwhResponse.ok && ampereResponse.ok) {
                const kwhData = await kwhResponse.json();
                const ampereData = await ampereResponse.json();
                
                if (kwhData.values && kwhData.values.length > 0) {
                    const kwhValues = kwhData.values;
                    const currentKwh = kwhValues[kwhValues.length - 1];
                    const maxKwh = Math.max(...kwhValues);
                    const totalKwh = kwhValues.reduce((sum, value) => sum + value, 0);
                    
                    document.getElementById('energy-current-kwh').textContent = currentKwh.toFixed(2);
                    document.getElementById('energy-max-kwh').textContent = maxKwh.toFixed(2);
                    document.getElementById('energy-total-kwh').textContent = totalKwh.toFixed(2);
                }
                
                if (ampereData.values && ampereData.values.length > 0) {
                    const maxAmpere = Math.max(...ampereData.values);
                    document.getElementById('energy-max-ampere').textContent = maxAmpere.toFixed(2);
                }
            }
        } catch (error) {
            console.error('Erro ao carregar estatísticas de energia:', error);
        }
    }
</script>
{% endblock %}
